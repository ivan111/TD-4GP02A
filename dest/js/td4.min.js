var ec=function(){function n(a){console.log(a);throw a;}function B(a,b){return function(){return a[b].apply(a,arguments)}}function s(){v.start()}function k(a){v.add(a)}function e(a){return{type:1,name:a}}function g(a){return{type:2,name:a}}function h(a,b,t){var c,m,l;a.PINS=b;for(c=0;c<b.length;c++)if(b[c]){switch(b[c].type){case 1:l=new d(a);break;case 2:l=new J;break;case 3:l=null;break;case 4:l=null;break;default:n("unknown io type")}m=b[c].name;a[m]&&n(m+" exists already");a[m]=l;a["PIN"+(c+1)]=
l}if(t)for(t=Array.prototype.slice.call(t,0),c=0;c<t.length;c++)(b=a["PIN"+(c+1)])&&b.connect(t[c]);a.action||(a._action?Object.getPrototypeOf(a).action=function(){k(B(this,"_action"))}:Object.getPrototypeOf(a).action=function(){});Object.getPrototypeOf(a).connect=function(a,t){this[a]||n("has not "+a+" pin");this[a].connect(t)}}function p(a,b,t,c){return function(m){var l,f="";arguments.length===b&&(m=Array.prototype.slice.call(arguments,0));c&&(f="_"+c);if(t)for(l=0;l<b;l++)this[a+l+f].connect(m[l]);
else for(l=0;l<b;l++)this[a+(l+1)+f].connect(m[l])}}function w(a){function b(t){this.isConnector=!0;this.inn=new y;this.out=null;a||this.inn.addChangeListener(this);t&&this.addChangeListener(t)}b.prototype.isInput=function(){return a};b.prototype.isOutput=function(){return!a};b.prototype.addChangeListener=function(a){this.inn.addChangeListener(a)};b.prototype.connect=function(b){var c;if(b.isWire)c=b,this.out&&n("couldn't connect wire");else if(b.isConnector){this.isOutput()&&b.isOutput()&&n("couldn't connect. output <=> output");
this.isInput()&&b.isInput()&&n("couldn't connect. input <=> input");if(this.out&&!b.out){b.connect(this);return}!this.out&&b.out?c=b.out:this.out||b.out?n("couldn't connect. wire <=> wire"):(c=new y,b.connect(c))}else n("couldn't connect type");this.out=c;a&&c.addChangeListener(this);this.action()};b.prototype.action=function(){this.out&&this.inn.getSignal()!==this.out.getSignal()&&(a?this.inn.setSignal(this.out.getSignal()):this.out.setSignal(this.inn.getSignal()))};b.prototype.getSignal=function(){return this.inn.getSignal()};
b.prototype.setSignal=function(b){a&&n("can not set signal to a input connector");this.inn.setSignal(b)};return b}function b(a){function b(){var c;h(this,m,arguments);this.state=[];for(c=0;c<a;c++)this.state.push(0),this["Y"+c].setSignal(0)}var c,m=[];for(c=0;c<a;c++)m.push(g("Y"+c));b.prototype.on=function(b){(0>b||b>=a)&&n("[DIPSW on] out of index");this.state[b]=1;this["Y"+b].setSignal(this.state[b])};b.prototype.off=function(b){(0>b||b>=a)&&n("[DIPSW off] out of index");this.state[b]=0;this["Y"+
b].setSignal(this.state[b])};b.prototype.toggle=function(b){(0>b||b>=a)&&n("[DIPSW toggle] out of index");this.state[b]=1-this.state[b];this["Y"+b].setSignal(this.state[b])};b.prototype.connectBus=p("Y",a,!0);return b}var z,I,x,v,y,c,d,J,F,G,H,D,C,q,E,l,a,m,u,f,N,O,P,L,M,Q;z=function(a){return("function"===typeof Array.prototype.indexOf?Array.prototype.indexOf:function(a){for(var b=-1,c=-1,b=0;b<this.length;b++)if(this[b]===a){c=b;break}return c}).call(this,a)};v={isProcessing:!1,queue:[],add:function(a){this.queue.push(a)},
start:function(){var a;if(!this.isProcessing){for(this.isProcessing=!0;0<this.queue.length&&this.isProcessing;)a=this.queue.shift(),a();this.isProcessing=!1}},stop:function(){this.isProcessing=!1}};I={type:3,name:"VCC"};x={type:4,name:"GND"};y=function(){function a(){this.instanceNo=b++;this.instanceName="Wire"+this.instanceNo;this.isWire=!0;this._signal=null;this._listeners=[]}var b=0;a.prototype.toString=function(){return this.instanceName};a.prototype.getSignal=function(){return this._signal};
a.prototype.setDelayedSignal=function(a){this.setSignal(a,!0)};a.prototype.setSignal=function(a,b){var c,m;null===a||0<=a&&1>=a?this._signal!==a&&(c=this,m=function(){c._signal=a;c.notifyListeners()},b?k(m):m()):n("Invalid signal "+a)};a.prototype.addChangeListener=function(a){-1!==z.call(this._listeners,a)&&n("couldn't add the listener. this listener was already added");this._listeners.push(a)};a.prototype.removeChangeListener=function(a){a=z.call(this._listeners,a);-1===a&&n("couldn't remove the listener. this listener doesn't exist");
this._listeners.splice(a,1)};a.prototype.notifyListeners=function(){var a;for(a=0;a<this._listeners.length;a++)this._listeners[a].action(this._signal)};return a}();c=function(){function a(b){var c;this.isBus=!0;for(c=0;c<b;c++)this.push(new y)}a.prototype=[];a.prototype.getSignals=function(){var a,b=[];for(a=0;a<this.length;a++)b.push(this[a].getSignal());return b};a.prototype.setSignals=function(){var a;for(a=0;a<this.length;a++)this[a].setSignal(arguments[a])};a.prototype.getValue=function(){var a,
b,c=0;for(a=0;a<this.length;a++){b=this[a].getSignal();if(null===b)return null;c|=b<<a}return c};a.prototype.setValue=function(a){var b;for(b=0;b<this.length;b++)this[b].setSignal((a&1<<b)>>b)};return a}();d=w(!0);J=w(!1);F=function(){function a(){h(this,b,arguments);this._interval=1E3;this._timerId=null;this._listeners=[];this.signal=1}var b=[g("CK")];a.prototype.isRunning=function(){return this._timerId?!0:!1};a.prototype.start=function(a){this._timerId||(a&&this.setHz(a),this._timerId=setInterval(B(this,
"next"),this._interval/2))};a.prototype.stop=function(){this._timerId&&(clearInterval(this._timerId),this._timerId=null)};a.prototype.setHz=function(a){this._interval=1E3/a;this._timerId&&(this.stop(),this.start())};a.prototype.next=function(){this.signal=1-this.signal;this.CK.setSignal(this.signal);s();this.notifyListeners()};a.prototype.addClockListener=function(a){-1!==z.call(this._listeners,a)&&n("couldn't add the listener. this listener was already added");this._listeners.push(a)};a.prototype.notifyListeners=
function(){var a;for(a=0;a<this._listeners.length;a++)this._listeners[a].onClock(this.signal)};return a}();H=function(){function a(c){var m;1!==c&&(c=0);this.normalSignal=c;this.pushed=!1;m=Array.prototype.slice.call(arguments,1);h(this,b,m)}var b=[g("Y")];a.prototype._action=function(){this.pushed?this.Y.setSignal(1-this.normalSignal):this.Y.setSignal(this.normalSignal)};a.prototype.down=function(){this.pushed=!0;this.action()};a.prototype.up=function(){this.pushed=!1;this.action()};return a}();
G=function(){var a=[e("A")];return function(){h(this,a,arguments)}}();D=function(){function a(){h(this,b,arguments)}var b=[e("L1"),e("L2"),g("C")];a.prototype._action=function(){var a;a=this.sw?this.L2.getSignal():this.L1.getSignal();this.C.setSignal(a)};a.prototype.toggle=function(){this.sw=!this.sw;this.action()};return a}();C=b(4);q=b(8);E=function(){function a(){h(this,b,arguments)}var b=[e("CK"),e("D"),e("CLR_B"),e("PR_B"),g("Q"),g("Q_B")];a.prototype._action=function(){var a=this.CK.getSignal(),
b;0===this.CLR_B.getSignal()?(this.Q.setSignal(0),this.Q_B.setSignal(1)):0===this.PR_B.getSignal()?(this.Q.setSignal(1),this.Q_B.setSignal(0)):0===this._prev_ck&&1===a&&(b=this.D.getSignal(),0===b||1===b?(this.Q.setSignal(b),this.Q_B.setSignal(1-b)):(this.Q.setSignal(null),this.Q_B.setSignal(null)));this._prev_ck=a};return a}();l=function(){function a(){h(this,b,arguments)}var b=[e("A"),g("Y")];a.prototype._action=function(){var a;a=this.A.getSignal();null===a?a=null:0===a?a=1:1===a?a=0:(n("[not] Invalid signal. s = "+
a),a=void 0);this.Y.setSignal(a)};return a}();m=function(){function a(){h(this,b,arguments)}var b=[e("A"),e("B"),g("Y")];a.prototype._action=function(){var a=this.A.getSignal(),b=this.B.getSignal();this.Y.setSignal(null===a||null===b?null:1===a&&1===b?1:0)};return a}();a=function(){function a(){h(this,b,arguments)}var b=[e("A"),e("B"),g("Y")];a.prototype._action=function(){var a=this.A.getSignal(),b=this.B.getSignal();this.Y.setSignal(null===a||null===b?null:0===a&&0===b?0:1)};return a}();u=function(){function a(){h(this,
b,arguments)}var b=[e("A"),e("B"),g("Y")];a.prototype._action=function(){var a=this.A.getSignal(),b=this.B.getSignal();this.Y.setSignal(null===a||null===b?null:1===a&&1===b?0:1)};return a}();f=function(){function a(){h(this,b,arguments)}var b=[e("A"),e("B"),e("C"),g("Y")];a.prototype._action=function(){var a=this.A.getSignal(),b=this.B.getSignal(),c=this.C.getSignal();this.Y.setSignal(null===a||null===b||null===c?null:1===a&&1===b&&1===c?0:1)};return a}();L=function(){var b=[e("A"),e("B"),g("S"),
g("C")];return function(){var c=new y,f=new y;h(this,b,arguments);this.elems=[];this.elems[0]=new a(this.A.inn,this.B.inn,c);this.elems[1]=new m(this.A.inn,this.B.inn,this.C.inn);this.elems[2]=new l(this.C.inn,f);this.elems[3]=new m(c,f,this.S.inn)}}();M=function(){var b=[e("A"),e("B"),e("C_IN"),g("S"),g("C_OUT")];return function(){var c=new y,m=new y,l=new y;h(this,b,arguments);this.elems=[];this.elems[0]=new L(this.B.inn,this.C_IN.inn,c,m);this.elems[1]=new L(this.A.inn,c,this.S.inn,l);this.elems[2]=
new a(m,l,this.C_OUT.inn)}}();N=function(){function a(){h(this,b,arguments)}var b=[e("G_1_B"),e("B"),e("C3_1"),e("C2_1"),e("C1_1"),e("C0_1"),g("Y_1"),x,g("Y_2"),e("C0_2"),e("C1_2"),e("C2_2"),e("C3_2"),e("A"),e("G_2_B"),I];a.prototype._action=function(){var a,b=this.A.getSignal(),c=this.B.getSignal(),m;for(a=1;2>=a;a++)if(1===this["G_"+a+"_B"].getSignal())this["Y_"+a].setSignal(0);else{if(null===b||null===c)break;m=(c<<1)+b;0<=m&&4>m||n("IC74HC153: out of index. ["+m+"]");this["Y_"+a].setSignal(this["C"+
m+"_"+a].getSignal())}};a.prototype.connectC_1=p("C",4,!0,1);a.prototype.connectC_2=p("C",4,!0,2);return a}();O=function(){function a(){h(this,b,arguments);this.carry=this.counter=0;this.outputSignal()}var b=[e("CLR_B"),e("CK"),e("A"),e("B"),e("C"),e("D"),e("ENP"),x,e("LD_B"),e("ENT"),g("QD"),g("QC"),g("QB"),g("QA"),g("CO"),I];a.prototype._action=function(){var a=this.CK.getSignal();0===this.CLR_B.getSignal()?(this.carry=this.counter=0,this.outputSignal()):0===this._prev_ck&&1===a&&(0===this.LD_B.getSignal()?
(this.load(),this.outputSignal()):1===this.ENP.getSignal()&&1===this.ENT.getSignal()&&(this.countup(),this.outputSignal()));this._prev_ck=a};a.prototype.load=function(){var a=this.A.getSignal(),b=this.B.getSignal(),c=this.C.getSignal(),m=this.D.getSignal();null!==a&&null!==b&&null!==c&&null!==m||n("IC74HC161: load error");this.counter=m<<3|c<<2|b<<1|a};a.prototype.outputSignal=function(){var a=this.counter;this.QA.setSignal(a&1);this.QB.setSignal((a&2)>>1);this.QC.setSignal((a&4)>>2);this.QD.setSignal((a&
8)>>3);this.CO.setSignal(this.carry)};a.prototype.countup=function(){this.counter++;16<=this.counter?(this.counter=0,this.carry=1):this.carry=0};a.prototype.connectInput=function(a){4===arguments.length&&(a=Array.prototype.slice.call(arguments,0));this.A.connect(a[0]);this.B.connect(a[1]);this.C.connect(a[2]);this.D.connect(a[3])};a.prototype.connectOutput=function(a){4===arguments.length&&(a=Array.prototype.slice.call(arguments,0));this.QA.connect(a[0]);this.QB.connect(a[1]);this.QC.connect(a[2]);
this.QD.connect(a[3])};return a}();P=function(){function a(){var c,m=this.C0,l;h(this,b,arguments);m=this.C0.inn;for(c=1;4>=c;c++)l=4===c?this.C4.inn:new y,this["fa"+c]=new M(this["A"+c].inn,this["B"+c].inn,m,this["S"+c].inn,l),m=l}var b=[g("S2"),e("B2"),e("A2"),g("S1"),e("A1"),e("B1"),e("C0"),x,g("C4"),g("S4"),e("B4"),e("A4"),g("S3"),e("A3"),e("B3"),I];a.prototype.connectA=p("A",4,!1);a.prototype.connectB=p("B",4,!1);a.prototype.connectS=p("S",4,!1);return a}();Q=function(a,b){function c(){var a,
m;h(this,l,arguments);m=1<<b;this.data=[];for(a=0;a<m;a++)this.data.push(0)}var m,l=[];for(m=0;m<a;m++)l.push(e("A"+m));for(m=0;m<b;m++)l.push(g("D"+m));c.prototype._action=function(){var a;a=this.getAddr();a=this.load(a);this.setData(a)};c.prototype.getAddr=function(){var b,c,m=[];for(b=0;b<a;b++){c=this["A"+b].getSignal();if(null===c)return null;m.push(c)}for(b=c=0;b<a;b++)c|=m[b]<<b;return c};c.prototype.setData=function(a){var c;if(null===a)for(c=0;c<b;c++)this["D"+c].setSignal(null);else for(c=
0;c<b;c++)this["D"+c].setSignal((a&1<<c)>>c)};c.prototype.load=function(a){if(null===a)return null;(0>a||a>=this.data.length)&&n("memory load: out of addr");return this.data[a]};c.prototype.store=function(a,b){if(null===a)return null;(0>a||a>=this.data.length)&&n("memory store: out of addr");this.data[a]=b};c.prototype.connectAddrBus=p("A",a,!0);c.prototype.connectDataBus=p("D",b,!0);return c}(4,8);return{Wire:y,Bus:c,LED:G,PushSW:H,Switch:D,DIPSW4:C,DIPSW8:q,Clock:F,Inverter:l,AndGate:m,OrGate:a,
NandGate:u,Nand3Gate:f,DFlipFlop:E,HalfAdder:L,FullAdder:M,IC74HC153:N,IC74HC161:O,IC74HC283:P,MemoryA4D8:Q,delay:k,start:s}}();var ve=function(){function n(b){console.log(b);throw b;}function B(b,a){return function(){return b[a].apply(b,arguments)}}function s(b,a){return 1===b?a?"#CC0052":"#FF66A3":0===b?a?"#00A3CC":"#66E0FF":"#888"}function k(b,a){return{x:b,y:a,direction:1}}function e(b,a){return{x:b,y:a,direction:2}}function g(b,a){return{x:b,y:a,direction:3}}function h(b,a,c,u){var f,d,g;for(f in c)c.hasOwnProperty(f)&&(d=c[f],(1>d||d>a)&&n("out of pin column index"),g=28,d=10*(d-(a+1)/2),v.test(f)&&(g+=6),b[f]=u?k(-g,
d):e(g,d))}function p(b,a,c){var u,f;this.isFlipped=!1;c?(c=Array.prototype.slice.call(c,0),b.x=c[0]||0,b.y=c[1]||0):(b.x=0,b.y=0);if(a&&b.cn_pos)for(u in b.cn={},b.cn_pos)b.cn_pos.hasOwnProperty(u)&&(a[u]||n(u+" is not a pin name"),c=new d(b,b.cn_pos[u],a[u]),b.cn[u]=c,a[u].addChangeListener(c));if(a&&a.PINS)for(b.PINS=a.PINS,u=0;u<a.PINS.length;u++)a.PINS[u]&&(b[a.PINS[u].name]=a[a.PINS[u].name],b["PIN"+(u+1)]=a["PIN"+(u+1)]);Object.getPrototypeOf(b).setPos=function(a,b){this.x=a;this.y=b};Object.getPrototypeOf(b).flip=
function(){this.isFlipped=!this.isFlipped};for(f in a)"function"!==typeof a[f]||b[f]||(b[f]=B(a,f))}function w(b){b.x=Math.round(b.x)+.5;b.y=Math.round(b.y)+.5;return b}var b,z=.5*Math.PI,I=1.5*Math.PI,x=2*Math.PI,v=/_B$/,y=/_\d$/,c,d,J,F,G,H,D,C,q,E;c=function(){function c(){this.i=0;this.path=[];this.signal=this.points=null;this.isVisible=!0;this.cns=[];this.align_tbl={}}c.prototype.draw=function(a){this.isVisible&&(this.points&&(this.path.push(this.points),this.points=void 0),0!==this.path.length&&
(b.save(),this.isClockPath?(b.lineWidth=2,b.strokeStyle=s(this.signal,!0)):a?(b.lineWidth=2,b.strokeStyle=a):(b.lineWidth=1,b.strokeStyle=s(this.signal)),b.fillStyle=b.strokeStyle,this._drawSub(),b.restore()))};c.prototype.erase=function(){b.save();b.lineWidth=3;b.strokeStyle="white";b.fillStyle=b.strokeStyle;this._drawSub(!0);b.restore()};c.prototype._drawSub=function(a){var c,u,f;for(c=0;c<this.path.length;c++)if(f=this.path[c],!(2>f.length)){0!==c&&(b.beginPath(),a?b.arc(f[0].x,f[0].y,4,0,x):b.arc(f[0].x,
f[0].y,3,0,x),b.fill());b.beginPath();b.moveTo(f[0].x,f[0].y);for(u=1;u<f.length;u++)b.lineTo(f[u].x,f[u].y);b.stroke()}};c.prototype.setVisible=function(a){this.isVisible!==a&&((this.isVisible=a)?this.draw():this.erase())};c.prototype.action=function(a){this.signal=a;this.draw()};c.prototype.onClock=function(a){this.isClockPath||1!==a||(0===this._prevSignalOnClock&&1===this.signal?(this.draw("#CC0052"),this._prevChanged=!0):1===this._prevSignalOnClock&&0===this.signal?(this.draw("#00A3CC"),this._prevChanged=
!0):this._prevChanged&&(this.erase(),this.draw(),this._prevChanged=!1),this._prevSignalOnClock=this.signal)};c.prototype.setClockPath=function(){var a;this.isClockPath=!0;for(a=0;a<this.cns.length;a++)this.cns[a].setClockConnector()};c.prototype.probe=function(a){a.isWire?a.addChangeListener(this):a.isConnector?a.inn.addChangeListener(this):n("couldn't probe")};c.prototype.addConnector=function(a){this._prevSignalOnClock=this.signal=a.e.getSignal();this.isClockPath&&a.setClockConnector();this.cns.push(a)};
c.prototype.contains=function(a){var b;for(b=0;b<this.cns.length;b++)if(this.cns[b]===a)return!0;return!1};c.prototype.setAlign=function(a,b,c){var f;for(f=0;f<this.cns.length;f++)this.cns[f]===a&&(this.align_tbl[a]||(this.align_tbl[a]=[]),this.align_tbl[a].push({d:c,type:b}))};c.prototype.moveTo=function(){this.points&&this.path.push(this.points);this.points=[];this.lineTo.apply(this,arguments)};c.prototype.lineTo=function(){var a,b=arguments;0===b.length&&n("no arguments");this.points||n("call moveTo before call lineTo");
if("number"===typeof b[0]&&0===b.length%2)for(a=0;a<b.length;a+=2)this.points.push(w({x:b[a],y:b[a+1]}));else if(1===b.length&&"[object Array]"===Object.prototype.toString.call(b[0]))for(a=0;a<b[0].length;a++)this.lineTo(b[0][a]);else 1===b.length&&b[0].isVeConnector?(a=b[0].getPos(),this.points.push(w({x:a.x,y:a.y}))):1===b.length?this.points.push(w({x:b[0].x,y:b[0].y})):n("invalid arguments")};c.prototype.autoPath=function(a,b){var c,f=a.getPos(),d=b.getPos(),e=a.getDirection(),l=b.getDirection(),
g,q,h=0,n=0,k=0,t,p;g=1===e||2===e?!0:!1;q=1===l||2===l?!0:!1;if(this.align_tbl[a])for(t=this.align_tbl[a],c=0;c<t.length;c++)3===t[c].type?n=t[c].d:1===t[c].type?h+=(f.y-d.y)/2:(h=t[c].d,p=t[c].type);if(this.align_tbl[b])for(t=this.align_tbl[b],c=0;c<t.length;c++)3===t[c].type?k=t[c].d:1===t[c].type?h+=(d.y-f.y)/2:(h=t[c].d,p=t[c].type);h||(h=0);c=20+n;k=20+k;1===e&&(c=-c);1===l&&(k=-k);this.moveTo(f);g!==q?g?this.lineTo(d.x,f.y):this.lineTo(f.x,d.y):2===p?(this.lineTo(f.x+c,f.y),this.lineTo(f.x+
c,h),this.lineTo(d.x+k,h),this.lineTo(d.x+k,d.y)):e===l?(this.lineTo(f.x+c,f.y),f.x!==d.x&&(this.lineTo(f.x+c,(f.y+d.y)/2+h),this.lineTo(d.x+k,(f.y+d.y)/2+h)),this.lineTo(d.x+k,d.y)):(g&&this.lineTo(f.x+c,f.y),f.y!==d.y&&(this.lineTo(f.x+c,(f.y+d.y)/2+h),this.lineTo(d.x+k,(f.y+d.y)/2+h)),q&&this.lineTo(d.x+k,d.y));this.lineTo(d)};c.prototype.searchNearestPoint=function(a){var b,c,f,d,e,l=9999,g={x:a.x,y:a.y};for(d=0;d<this.path.length;d++)for(e=this.path[d],f=0;f<e.length-1;f++){b=e[f];var h=e[f+
1],q=a,k=9999;c={x:0,y:0};var p=void 0,t=void 0;b.x===h.x?(p=Math.min(b.y,h.y),t=Math.max(b.y,h.y),p<=q.y&&q.y<=t&&(k=Math.abs(b.x-q.x),c={x:b.x,y:q.y})):b.y===h.y?(p=Math.min(b.x,h.x),t=Math.max(b.x,h.x),p<=q.x&&q.x<=t&&(k=Math.abs(b.y-q.y),c={x:q.x,y:b.y})):n("calcDist error");b=k;b<l&&(l=b,g=c)}return g};c.prototype.addAutoPath=function(a){var b=a.getPos(),c={},f,d;f=0;var e=a.getDirection();this.moveTo({x:0,y:0});0===this.path.length&&n("can't addAutoPath to empty path");if(this.align_tbl[a])for(d=
this.align_tbl[a],a=0;a<d.length;a++)3===d[a].type&&(f=d[a].d);f||(f=0);c.x=1===e?b.x-20-f:b.x+20+f;c.y=b.y;f=this.searchNearestPoint(c);this.points[0]=w(f);this.lineTo(c);this.lineTo(b)};c.prototype.getPrev=function(){var a;0===this.points.length&&n("couldn't get prev point");a=this.points.length-1;return{x:this.points[a].x,y:this.points[a].y}};c.prototype.left=function(a){var b=this.getPrev();this.points.push(w({x:b.x-a,y:b.y}))};c.prototype.right=function(a){var b=this.getPrev();this.points.push(w({x:b.x+
a,y:b.y}))};c.prototype.up=function(a){var b=this.getPrev();this.points.push(w({x:b.x,y:b.y-a}))};c.prototype.down=function(a){var b=this.getPrev();this.points.push(w({x:b.x,y:b.y+a}))};c.prototype.calc=function(){var a,b=-1,c,f,d,e;if(!(2>this.cns.length)){e=this.cns.slice(0);a=[e[0],e[1]];if(2<e.length)for(c=0;c<e.length-1;c++)for(f=c+1;f<e.length;f++){d=e[c].getPos();var l=e[f].getPos(),g=void 0,h=void 0,g=l.x-d.x,h=l.y-d.y;d=Math.sqrt(g*g+h*h);d>b&&(b=d,a=[e[c],e[f]])}for(f=0;2>f;f++)for(c=0;c<
e.length;c++)if(e[c]===a[f]){e.splice(c,1);break}this.autoPath(a[0],a[1]);for(c=0;c<e.length;c++)this.addAutoPath(e[c])}};return c}();d=function(){function c(b,d,f){this.instanceNo=a++;this.instanceName="ViConnector"+this.instanceNo;this.isVeConnector=!0;this.parent=b;this.cn_pos=d;this.e=f}var a=0;c.prototype.toString=function(){return this.instanceName};c.prototype.draw=function(a){var c=0;1===this.cn_pos.direction?c=-3:2===this.cn_pos.direction&&(c=3);this.parent.isFlipped&&(c=-c);b.save();b.fillStyle=
this.isClockConnector?s(this.signal,!0):a?a:s(this.signal);b.beginPath();b.arc(this.getX()+c,this.getY(),3,0,x);b.fill();b.restore()};c.prototype.action=function(){this.signal=this.e.getSignal();this.draw()};c.prototype.onClock=function(a){this.isClockConnector||1!==a||(0===this._prevSignalOnClock&&1===this.signal?(this.draw("#CC0052"),this._prevChanged=!0):1===this._prevSignalOnClock&&0===this.signal?(this.draw("#00A3CC"),this._prevChanged=!0):this._prevChanged&&(this.draw(),this._prevChanged=!1),
this._prevSignalOnClock=this.signal)};c.prototype.setClockConnector=function(){this.isClockConnector=!0};c.prototype.getDirection=function(){var a=this.cn_pos.direction;if(this.parent.isFlipped){if(1===a)return 2;if(2===a)return 1}return a};c.prototype.getPos=function(){return{x:this.getX(),y:this.getY()}};c.prototype.getX=function(){return this.parent.isFlipped?this.parent.x-this.cn_pos.x:this.parent.x+this.cn_pos.x};c.prototype.getY=function(){return this.parent.y+this.cn_pos.y};return c}();J=function(){function c(){this.e=
new ec.Inverter;this.h=this.w=30;p(this,this.e,arguments)}c.prototype.cn_pos={A:k(-15,0),Y:e(21,0)};c.prototype.draw=function(){b.save();b.translate(this.x,this.y);this.isFlipped&&b.scale(-1,1);b.beginPath();b.moveTo(-15,-15);b.lineTo(-15,15);b.lineTo(15,0);b.closePath();b.stroke();b.beginPath();b.arc(18,0,3,0,x);b.stroke();b.restore()};return c}();F=function(){function c(){this.e=new ec.AndGate;this.w=32;this.h=30;p(this,this.e,arguments)}c.prototype.cn_pos={A:k(-16,-7.5),B:k(-16,7.5),Y:e(16,0)};
c.prototype.draw=function(){b.save();b.translate(this.x,this.y);this.isFlipped&&b.scale(-1,1);b.beginPath();b.moveTo(2,-15);b.lineTo(-16,-15);b.lineTo(-16,15);b.lineTo(2,15);b.stroke();b.beginPath();b.arc(2,0,15,I,z);b.stroke();b.restore()};return c}();G=function(){function c(){this.e=new ec.OrGate;this.w=36;this.h=30;p(this,this.e,arguments)}c.prototype.cn_pos={A:k(-12,-7.5),B:k(-12,7.5),Y:e(18,0)};c.prototype.draw=function(){b.save();b.translate(this.x,this.y);this.isFlipped&&b.scale(-1,1);b.beginPath();
b.moveTo(-18,-15);b.quadraticCurveTo(9,-15,18,0);b.quadraticCurveTo(9,15,-18,15);b.quadraticCurveTo(0,0,-18,-15);b.stroke();b.restore()};return c}();H=function(){function c(){this.e=new ec.Nand3Gate;this.w=32;this.h=30;p(this,this.e,arguments)}c.prototype.cn_pos={A:k(-16,-7.5),B:k(-16,0),C:k(-16,7.5),Y:e(22,0)};c.prototype.draw=function(){b.save();b.translate(this.x,this.y);this.isFlipped&&b.scale(-1,1);b.beginPath();b.moveTo(2,-15);b.lineTo(-16,-15);b.lineTo(-16,15);b.lineTo(2,15);b.stroke();b.beginPath();
b.arc(2,0,15,I,z);b.stroke();b.beginPath();b.arc(19,0,3,0,x);b.stroke();b.restore()};return c}();D=function(){function c(){this.e=new ec.PushSW(1);this.w=40;this.h=20;p(this,this.e,arguments)}c.prototype.cn_pos={Y:e(0,-10)};c.prototype.draw=function(){var a;b.save();b.translate(this.x,this.y);b.font="9px Arial";b.textAlign="center";b.fillStyle="black";b.fillText("RESET",0,4);a=b.measureText("RESET").width;b.beginPath();b.moveTo(-a/2,-5);b.lineTo(a/2,-5);b.stroke();b.restore()};return c}();C=function(){function c(){this.e=
new ec.DIPSW4;this.w=40;this.h=20;p(this,this.e,arguments)}c.prototype.cn_pos={Y0:g(12,-13),Y1:g(4,-13),Y2:g(-4,-13),Y3:g(-12,-13)};c.prototype.draw=function(){b.save();b.translate(this.x,this.y);b.beginPath();b.lineWidth=1;b.strokeStyle="black";b.fillStyle="white";b.shadowColor="#999";b.shadowBlur=3;b.shadowOffsetX=3;b.shadowOffsetY=3;b.rect(-20,-10,40,20);b.stroke();b.fill();b.font="9px Arial";b.shadowColor="transparent";b.textAlign="center";b.fillStyle="black";b.fillText("DIPSW",0,4);b.restore()};
return c}();q=function(){function c(a){var b;a||(a="red");this.color=a;this.signal=0;this.e=new ec.LED;this.h=this.w=8;b=Array.prototype.slice.call(arguments,1);p(this,this.e,b);this.A.addChangeListener(this)}c.prototype.cn_pos={A:g(0,-7)};c.prototype.draw=function(){b.save();b.translate(this.x,this.y);b.lineWidth=1;b.strokeStyle="black";b.beginPath();b.arc(0,0,4,0,x);b.fillStyle=this.signal?this.color:"white";b.fill();b.stroke();b.restore()};c.prototype.action=function(a){this.signal=a;this.draw()};
return c}();E=function(){function c(){this.e=new ec.Clock;this.h=this.w=30;p(this,this.e,arguments);this.CK.addChangeListener(this)}var a=270;c.prototype.cn_pos={CK:e(15,0)};c.prototype.start=function(b){a=270;this.e.start(b)};c.prototype.stop=function(){a=270;this.e.stop();this.draw()};c.prototype.draw=function(){b.save();b.translate(this.x,this.y);b.beginPath();b.arc(0,0,15,0,x);b.stroke();b.restore();this.action(0)};c.prototype.action=function(c){1===c&&(a+=6,360<=a&&(a=0));b.save();b.translate(this.x,
this.y);b.beginPath();b.arc(0,0,12,0,x);b.fillStyle="white";b.fill();b.beginPath();b.moveTo(0,0);c=Math.PI*a/180;b.lineTo(12*Math.cos(c),12*Math.sin(c));b.stroke();b.restore()};return c}();return{setCanvasContext:function(c){b=c},createDIP_IC:function(c,a,d,e){function f(){this.e=new c;this.w=56;this.h=g;p(this,this.e,arguments)}var g=10*a+8,q=g/2;f.prototype.cn_pos={};h(f.prototype.cn_pos,a,d,!0);h(f.prototype.cn_pos,a,e,!1);f.prototype.draw=function(){var a,c,d,f,e,m,h,l,u;b.save();b.translate(this.x,
this.y);this.isFlipped&&b.scale(-1,1);b.beginPath();b.strokeStyle="black";b.fillStyle="white";b.lineWidth=2;b.rect(-28,-q,56,g);b.shadowColor="#999";b.shadowBlur=3;b.shadowOffsetX=3;b.shadowOffsetY=3;b.stroke();b.fill();b.font="9px Arial";b.shadowColor="transparent";b.lineWidth=1;b.fillStyle="black";for(a in this.cn_pos)this.cn_pos.hasOwnProperty(a)&&(d=this.cn_pos[a],c=a,(f=v.test(a))&&(c=c.substr(0,c.length-2)),y.test(c)&&(c=c.charAt(c.length-1)+c.substr(0,c.length-2)),f=v.test(a),2===d.direction?
(b.textAlign="right",e=28,m=d.x-3,h=e-3,l=h-b.measureText(c).width,u=e-3):(b.textAlign="left",e=-28,m=d.x+3,h=e+3,l=h+b.measureText(c).width,u=e+3),f&&(b.beginPath(),b.arc(m,d.y,3,0,x),b.stroke(),b.beginPath(),b.moveTo(h,d.y-5),b.lineTo(l,d.y-5),b.stroke()),"CK"===a&&(b.beginPath(),b.moveTo(e,d.y-3),b.lineTo(u,d.y),b.lineTo(e,d.y+3),b.stroke()),b.fillText(c,h,d.y+3));b.restore()};return f},createAutoPath:function(b){function a(){var a,d,e,m,g,h;this.wire2cn={};this.paths=[];for(d in b)if(b.hasOwnProperty(d))for(m in a=
b[d],e=a.cn_pos,e)e.hasOwnProperty(m)&&(g=a[m].out)&&(this.wire2cn[g]||(this.wire2cn[g]=[g]),this.wire2cn[g].push(a.cn[m]));for(h in this.wire2cn)if(this.wire2cn.hasOwnProperty(h))for(e=this.wire2cn[h],d=new c,d.probe(e[0]),this.paths.push(d),a=1;a<e.length;a++)d.addConnector(e[a])}var d,e;if("[object Array]"===Object.prototype.toString.call(b)){e={};for(d=0;d<b.length;d++)e["e"+d]=b[d];b=e}a.prototype.setAlign=function(a,b,c){var d;for(d=0;d<this.paths.length;d++)if(this.paths[d].contains(a)){this.paths[d].setAlign(a,
b,c);break}};a.prototype.calc=function(){var a;for(a=0;a<this.paths.length;a++)this.paths[a].calc()};a.prototype.setClockListener=function(a){var b;a.addClockListener(this);for(b=0;b<this.paths.length;b++)if(this.paths[b].contains(a.cn.CK)){this.paths[b].setClockPath();break}};a.prototype.getPath=function(a){var b;for(b=0;b<this.paths.length;b++)if(this.paths[b].contains(a))return this.paths[b]};a.prototype.draw=function(){var a;for(a=0;a<this.paths.length;a++)this.paths[a].draw()};a.prototype.onClock=
function(a){var b,c,d;for(b=0;b<this.paths.length;b++)this.paths[b].onClock(a);for(c in this.wire2cn)if(this.wire2cn.hasOwnProperty(c))for(d=this.wire2cn[c],b=1;b<d.length;b++)d[b].onClock(a)};return new a},drawLabel:function(c,a){b.save();b.font="9px Arial";b.textAlign="center";b.fillStyle="black";b.fillText(c,a.x,a.y-a.h/2-5);b.restore()},DIP_WIDTH:56,DIP_H_UNIT:10,DIP_H_PAD:4,ALIGN_MID:0,ALIGN_PIN:1,ALIGN_PIN_TURN:3,ALIGN_TOP:2,Inverter:J,AndGate:F,OrGate:G,Nand3Gate:H,ResetButton:D,Clock:E,LED:q,
DIPSW4:C}}();var td4=function(){return{initModule:function(n){td4.shell.initModule(n)}}}();td4.shell=function(){function n(e,g){td4.schematic.writeCode(e,g)}var B,s,k;return{initModule:function(e){var g;e.html('<div class="td4-shell-head"><h1>TD-4GP02A</h1><</div><div class="td4-shell-main"><div class="td4-shell-main-left"><div class="td4-shell-main-schematic"></div><div class="td4-shell-main-ctrl"></div></div><div class="td4-shell-main-right"><div class="td4-shell-main-asm"></div></div></div><div class="td4-shell-foot">Created Date: 2014-07-20</div>');B=e.find(".td4-shell-main-schematic");
s=e.find(".td4-shell-main-ctrl");k=e.find(".td4-shell-main-asm");td4.schematic.initModule(B);td4.ctrl.initModule(s);td4.asm.initModule(k);td4.asm.addCodeChangeListener({onCodeChange:n});for(e=0;e<td4.asm.MAX_PC;e++)g=td4.asm.readCode(e),td4.schematic.writeCode(e,g);td4.schematic.reset();td4.schematic.startClock(1)},reset:function(){td4.schematic.reset()},isRunning:function(){return td4.schematic.isRunning()},startClock:function(e){td4.schematic.startClock(e)},stopClock:function(){td4.schematic.stopClock()},
manualClock:function(){td4.schematic.manualClock()},setInPort:function(e,g){td4.schematic.setInPort(e,g)},addOutpChangeListener:function(e){td4.schematic.addOutpChangeListener(e)},addPcChangeListener:function(e){td4.schematic.addPcChangeListener(e)},addClockStartedListener:function(e){td4.schematic.addClockStartedListener(e)},addClockStoppedListener:function(e){td4.schematic.addClockStoppedListener(e)},getRegisterA:function(){return td4.schematic.getRegisterA()},getRegisterB:function(){return td4.schematic.getRegisterB()},
getCarryFlag:function(){return td4.schematic.getCarryFlag()},showWire:function(e,g){td4.schematic.showWire(e,g)}}}();td4.schematic=function(){var n,B,s,k,e,g,h,p;function w(a){var b,c,d;b=a.QA.getSignal();c=a.QB.getSignal();d=a.QC.getSignal();a=a.QD.getSignal()<<3|d<<2|c<<1|b;return 0<=a&&16>a?a:null}function b(){for(name in c)if(c.hasOwnProperty(name))for(pinName in c[name].cn_pos)c[name].cn_pos.hasOwnProperty(pinName)&&c[name].cn[pinName].action()}function z(){h=new ec.Wire;p=new ec.Wire;n=new ec.Bus(4);B=new ec.Bus(4);s=new ec.Bus(4);k=new ec.Bus(4);e=new ec.Bus(8);g=new ec.Bus(4);(function(){var a;c.clock=new ve.Clock;
c.resetBtn=new ve.ResetButton;c.rom=new l;c.aReg=new q;c.bReg=new q;c.outp=new q;c.pc=new q;c.sel1=new C;c.sel2=new C;c.inp=new ve.DIPSW4;c.adder=new E;c.cf=new D;c.ic8a=new ve.OrGate;c.ic8b=new ve.OrGate;c.ic8c=new ve.OrGate;c.ic10c=new ve.Nand3Gate;c.ic8d=new ve.OrGate;c.ic10a=new ve.Nand3Gate;c.ic10b=new ve.Nand3Gate;for(a=0;4>a;a++)c["outLed"+a]=new ve.LED})();(function(){var a;c.clock.setPos(24,21);c.resetBtn.setPos(64,39);c.rom.setPos(730,500);c.aReg.setPos(150,200);c.bReg.setPos(c.aReg.x,c.aReg.y+
110);c.outp.setPos(c.bReg.x,c.bReg.y+110);c.pc.setPos(c.outp.x,c.outp.y+110);c.sel1.setPos(c.aReg.x+225,220);c.sel2.setPos(c.sel1.x,c.sel1.y+160);c.inp.setPos(c.sel2.x-90,c.sel2.y+100);c.adder.setPos(c.sel1.x+160,c.sel1.y-24);c.cf.setPos(c.adder.x+150,c.adder.y-30);c.ic8a.setPos(c.rom.x-370,c.rom.y+9);c.ic8b.setPos(c.rom.x-120,c.rom.y-104);c.ic8c.setPos(c.rom.x-14,c.cf.y+c.cf.h+54);c.ic8d.setPos(c.ic8c.x,c.ic8c.y+c.ic8c.h+10);c.ic10a.setPos(c.ic8b.x,c.ic8d.y-8);c.ic10b.setPos(c.ic8d.x,c.ic8d.y+c.ic8d.h+
10);c.ic10c.setPos(c.ic10b.x,c.ic10b.y+c.ic10b.h+10);for(a=0;4>a;a++)c["outLed"+a].setPos(c.outp.x+c.outp.w+(3-a)*ve.DIP_H_UNIT,c.outp.y+60)})();(function(){var a=c.clock;a.setHz(1);a.CK.connect(h)})();c.resetBtn.Y.connect(p);(function(){var a=c.rom;a.connectAddrBus(k);a.connectDataBus(e)})();(function(){var a=c.aReg;a.CK.connect(h);a.CLR_B.connect(p);a.ENT.inn.setSignal(0);a.ENP.inn.setSignal(0);a.LD_B.connect(c.ic8c.Y);a.connectInput(s);a.connectOutput(n)})();(function(){var a=c.bReg;a.CK.connect(h);
a.CLR_B.connect(p);a.ENT.inn.setSignal(0);a.ENP.inn.setSignal(0);a.LD_B.connect(c.ic8d.Y);a.connectInput(s);a.connectOutput(B)})();(function(){var a=c.outp;a.CK.connect(h);a.CLR_B.connect(p);a.ENT.inn.setSignal(0);a.ENP.inn.setSignal(0);a.LD_B.connect(c.ic10b.Y);a.connectInput(s);a.connectOutput(g)})();(function(){var a=c.pc;a.CK.connect(h);a.CLR_B.connect(p);a.ENT.inn.setSignal(1);a.ENP.inn.setSignal(1);a.LD_B.connect(c.ic10c.Y);a.connectInput(s);a.connectOutput(k)})();(function(){var a;for(a=0;4>
a;a++)c["outLed"+a].A.connect(c.outp["PIN"+(14-a)])})();(function(){var a=c.sel1,b=c.sel2,d=c.aReg,f=c.bReg,g=c.inp;a.G_1_B.inn.setSignal(0);a.G_2_B.inn.setSignal(0);b.G_1_B.inn.setSignal(0);b.G_2_B.inn.setSignal(0);a.A.connect(c.ic8a.Y);a.B.connect(e[5]);b.A.connect(c.ic8a.Y);b.B.connect(e[5]);a.C0_1.connect(d.QA);a.C0_2.connect(d.QB);b.C0_1.connect(d.QC);b.C0_2.connect(d.QD);a.C1_1.connect(f.QA);a.C1_2.connect(f.QB);b.C1_1.connect(f.QC);b.C1_2.connect(f.QD);a.C2_1.connect(g.Y0);a.C2_2.connect(g.Y1);
b.C2_1.connect(g.Y2);b.C2_2.connect(g.Y3);a.C3_1.inn.setSignal(0);a.C3_2.inn.setSignal(0);b.C3_1.inn.setSignal(0);b.C3_2.inn.setSignal(0)})();(function(){var a=c.adder,b=c.sel1,d=c.sel2,f=e;a.C0.inn.setSignal(0);a.connectA(b.Y_1,b.Y_2,d.Y_1,d.Y_2);a.connectB(f[0],f[1],f[2],f[3]);a.connectS(s)})();(function(){var a=c.cf;a.PR_B.inn.setSignal(1);a.CK.connect(h);a.CLR_B.connect(p);a.D.connect(c.adder.C4)})();(function(){var a=c.ic8a,b=c.ic8b,d=c.ic8c,f=c.ic8d,g=e;a.A.connect(g[4]);a.B.connect(g[7]);a.flip();
b.A.connect(c.cf.Q_B);b.B.connect(g[4]);d.A.connect(g[6]);d.B.connect(g[7]);f.A.connect(c.ic10a.Y);f.B.connect(g[7])})();(function(){var a=c.ic10a,b=c.ic10b,d=c.ic10c,f=e;a.A.inn.setSignal(1);a.B.inn.setSignal(1);a.C.connect(f[6]);b.A.inn.setSignal(1);b.B.connect(c.ic10a.Y);b.C.connect(f[7]);d.A.connect(f[6]);d.B.connect(f[7]);d.C.connect(c.ic8b.Y)})();(function(){var a;a=c.cf;var b=c.rom,e=c.aReg,f=c.bReg,g=c.outp,h=c.pc,l=c.sel1,q=c.sel2,k=c.adder,n=c.ic8a,p=c.ic8c,E=c.ic8d,t=c.ic10b,s=c.ic10c,
r=ve.DIP_H_UNIT-2;d=ve.createAutoPath(c);d.clock=d.getPath(c.clock.cn.CK);d.reset=d.getPath(c.aReg.cn.CLR_B);d.inp0=d.getPath(c.inp.cn.Y0);d.inp1=d.getPath(c.inp.cn.Y1);d.inp2=d.getPath(c.inp.cn.Y2);d.inp3=d.getPath(c.inp.cn.Y3);d.setAlign(a.cn.CK,ve.ALIGN_TOP,20);d.setAlign(a.cn.CLR_B,ve.ALIGN_TOP,20+r);d.setAlign(a.cn.CLR_B,ve.ALIGN_PIN_TURN,r-6);d.setAlign(a.cn.Q_B,ve.ALIGN_MID,-56);d.setAlign(a.cn.D,ve.ALIGN_PIN_TURN,2*r);d.setAlign(e.cn.QB,ve.ALIGN_PIN_TURN,2*r);d.setAlign(e.cn.QC,ve.ALIGN_PIN_TURN,
r);d.setAlign(f.cn.QA,ve.ALIGN_PIN_TURN,3*r);d.setAlign(f.cn.QB,ve.ALIGN_PIN_TURN,4*r);d.setAlign(f.cn.QC,ve.ALIGN_PIN_TURN,r);d.setAlign(l.cn.A,ve.ALIGN_PIN_TURN,r);d.setAlign(q.cn.A,ve.ALIGN_PIN_TURN,r);d.setAlign(l.cn.C1_1,ve.ALIGN_PIN,0);d.setAlign(l.cn.C0_2,ve.ALIGN_PIN,0);d.setAlign(l.cn.C1_2,ve.ALIGN_PIN,0);d.setAlign(q.cn.C0_1,ve.ALIGN_PIN_TURN,52);d.setAlign(q.cn.C0_1,ve.ALIGN_MID,-20);d.setAlign(q.cn.C1_1,ve.ALIGN_PIN,0);d.setAlign(q.cn.C0_2,ve.ALIGN_PIN_TURN,64);d.setAlign(q.cn.C0_2,ve.ALIGN_MID,
-40);d.setAlign(q.cn.C1_2,ve.ALIGN_PIN_TURN,84);d.setAlign(l.cn.Y_2,ve.ALIGN_PIN_TURN,r);d.setAlign(q.cn.Y_1,ve.ALIGN_PIN_TURN,2*r);d.setAlign(q.cn.Y_2,ve.ALIGN_PIN_TURN,3*r);a=50;d.setAlign(k.cn.S1,ve.ALIGN_TOP,a);d.setAlign(k.cn.S2,ve.ALIGN_TOP,a+r);d.setAlign(k.cn.S3,ve.ALIGN_TOP,a+2*r);d.setAlign(k.cn.S4,ve.ALIGN_TOP,a+3*r);d.setAlign(k.cn.S2,ve.ALIGN_PIN_TURN,r);d.setAlign(k.cn.S3,ve.ALIGN_PIN_TURN,2*r);d.setAlign(k.cn.S4,ve.ALIGN_PIN_TURN,3*r);d.setAlign(k.cn.B2,ve.ALIGN_PIN_TURN,r);d.setAlign(k.cn.B3,
ve.ALIGN_PIN_TURN,2*r);d.setAlign(k.cn.B4,ve.ALIGN_PIN_TURN,3*r);d.setAlign(k.cn.A1,ve.ALIGN_PIN,0);d.setAlign(k.cn.A2,ve.ALIGN_PIN,0);d.setAlign(k.cn.A3,ve.ALIGN_PIN,0);d.setAlign(k.cn.A4,ve.ALIGN_PIN,0);d.setAlign(k.cn.C4,ve.ALIGN_PIN,0);a=56;d.setAlign(h.cn.A,ve.ALIGN_PIN_TURN,a+3*r);d.setAlign(h.cn.B,ve.ALIGN_PIN_TURN,a+2*r);d.setAlign(h.cn.C,ve.ALIGN_PIN_TURN,a+r);d.setAlign(h.cn.D,ve.ALIGN_PIN_TURN,a);a=140;d.setAlign(n.cn.B,ve.ALIGN_PIN,0);d.setAlign(p.cn.A,ve.ALIGN_PIN_TURN,a);d.setAlign(p.cn.B,
ve.ALIGN_PIN_TURN,a+r);d.setAlign(E.cn.B,ve.ALIGN_PIN_TURN,4);d.setAlign(t.cn.B,ve.ALIGN_PIN,0);d.setAlign(t.cn.B,ve.ALIGN_PIN_TURN,r);d.setAlign(s.cn.A,ve.ALIGN_PIN_TURN,2*r);a=90;d.setAlign(p.cn.Y,ve.ALIGN_TOP,a);d.setAlign(E.cn.Y,ve.ALIGN_TOP,a+r);d.setAlign(t.cn.Y,ve.ALIGN_TOP,a+2*r);d.setAlign(s.cn.Y,ve.ALIGN_TOP,a+3*r);d.setAlign(E.cn.Y,ve.ALIGN_PIN_TURN,r);d.setAlign(t.cn.Y,ve.ALIGN_PIN_TURN,2*r-4);d.setAlign(s.cn.Y,ve.ALIGN_PIN_TURN,3*r-4);d.setAlign(n.cn.Y,ve.ALIGN_PIN,0);d.setAlign(h.cn.CLR_B,
ve.ALIGN_PIN_TURN,r-6);d.setAlign(g.cn.CLR_B,ve.ALIGN_PIN_TURN,r-6);d.setAlign(f.cn.CLR_B,ve.ALIGN_PIN_TURN,r-6);d.setAlign(e.cn.CLR_B,ve.ALIGN_PIN_TURN,r-6);d.setAlign(h.cn.LD_B,ve.ALIGN_PIN_TURN,2*r-6);d.setAlign(g.cn.LD_B,ve.ALIGN_PIN_TURN,3*r-6);d.setAlign(f.cn.LD_B,ve.ALIGN_PIN_TURN,4*r-6);d.setAlign(e.cn.LD_B,ve.ALIGN_PIN_TURN,5*r-6);d.setAlign(b.cn.A1,ve.ALIGN_MID,-r);d.setAlign(b.cn.A2,ve.ALIGN_MID,2*-r);d.setAlign(b.cn.A3,ve.ALIGN_MID,3*-r);d.setAlign(b.cn.D0,ve.ALIGN_PIN,0);d.setAlign(b.cn.D1,
ve.ALIGN_PIN,0);d.setAlign(b.cn.D2,ve.ALIGN_PIN,0);d.setAlign(b.cn.D3,ve.ALIGN_PIN,0);d.setAlign(b.cn.D4,ve.ALIGN_PIN,0);d.setAlign(b.cn.D5,ve.ALIGN_PIN,0);d.setAlign(b.cn.D6,ve.ALIGN_PIN,0);d.calc();d.setClockListener(c.clock)})();for(name in c)c.hasOwnProperty(name)&&c[name].draw();b();ve.drawLabel("A REG - 74HC161",c.aReg);ve.drawLabel("B REG - 74HC161",c.bReg);ve.drawLabel("OUTP - 74HC161",c.outp);ve.drawLabel("PC - 74HC161",c.pc);ve.drawLabel("SEL1 - 74HC153",c.sel1);ve.drawLabel("SEL2 - 74HC153",
c.sel2);ve.drawLabel("ADDER - 74HC283",c.adder);ve.drawLabel("FLAG - D Flip-Flop",c.cf);ve.drawLabel("ROM",c.rom);d.draw();(function(){c.clock.addClockListener(new function(){this.onClock=function(a){if(1===a&&(a=w(c.pc),null!==a&&a!==v.currentPc)){var b=v.currentPc,d;for(d=0;d<F.length;d++)F[d].onPcChange(a,b);v.currentPc=a}}})})();(function(){function a(a){this.action=function(b){1===b?x(a,!0):x(a,!1)}}c.outp.QA.addChangeListener(new a(0));c.outp.QB.addChangeListener(new a(1));c.outp.QC.addChangeListener(new a(2));
c.outp.QD.addChangeListener(new a(3))})()}function I(){c.clock.stop();c.clock.e.signal=1;c.clock.next();c.clock.next()}function x(a,b){var c;for(c=0;c<J.length;c++)J[c].onOutpChange(a,b)}var v={currentPc:0},y,c={};g=e=k=s=B=n=p=h=void 0;var d,J=[],F=[],G=[],H=[],D,C,q,E,l;D=ve.createDIP_IC(ec.DFlipFlop,4,{PR_B:1,CK:2,D:3,CLR_B:4},{Q:2,Q_B:3});C=ve.createDIP_IC(ec.IC74HC153,13,{A:1,B:2,G_1_B:4,C0_1:5,C1_1:6,C2_1:7,C3_1:8,G_2_B:9,C0_2:10,C1_2:11,C2_2:12,C3_2:13},{Y_1:6,Y_2:7});q=ve.createDIP_IC(ec.IC74HC161,
7,{CLR_B:1,LD_B:2,CK:3,A:4,B:5,C:6,D:7},{ENT:1,ENP:2,QA:4,QB:5,QC:6,QD:7});E=ve.createDIP_IC(ec.IC74HC283,11,{A1:1,A2:2,A3:3,A4:4,B1:6,B2:7,B3:8,B4:9,C0:11},{S1:1,S2:2,S3:3,S4:4,C4:6});l=ve.createDIP_IC(ec.MemoryA4D8,13,{D0:1,D1:2,D2:3,D3:4,D4:5,D5:6,D6:7,D7:8,A0:10,A1:11,A2:12,A3:13},{});return{initModule:function(a){a.html('<canvas class="td4-schematic-canvas" width="800" height="590">Canvas not supported</canvas>');y=a.find(".td4-schematic-canvas")[0];a=y.getContext("2d");ve.setCanvasContext(a);
z()},reset:function(){c.resetBtn.down();ec.start();I();c.resetBtn.up();ec.start()},isRunning:function(){return c.clock.isRunning()},startClock:function(a){c.clock.start(a);var b;for(b=0;b<G.length;b++)G[b].onClockStart(a)},stopClock:function(){c.clock.stop();var a;for(a=0;a<H.length;a++)H[a].onClockStop()},manualClock:I,setInPort:function(a,b){if(b)c.inp.on(a);else c.inp.off(a)},addOutpChangeListener:function(a){J.push(a)},addPcChangeListener:function(a){F.push(a)},addClockStartedListener:function(a){G.push(a)},
addClockStoppedListener:function(a){H.push(a)},getRegisterA:function(){return w(c.aReg)},getRegisterB:function(){return w(c.bReg)},getCarryFlag:function(){return c.cf.Q.getSignal()},showWire:function(a,c){var e,f=[];if("clock"===a)f.push(d.clock);else if("reset"===a)f.push(d.reset);else if("inp"===a)f.push(d.inp0),f.push(d.inp1),f.push(d.inp2),f.push(d.inp3);else return;for(e=0;e<f.length;e++)f[e].setVisible(c);d.draw();b()},readCode:function(a){return 0<=a&&16>a?c.rom.load(a):(console.log("[schematic] read code error: addr = "+
a),0)},writeCode:function(a,b){0<=a&&16>a&&0<=b&&256>b?(c.rom.store(a,b),v.currentPc===a&&(c.rom.action(),ec.start(),d.onClock(1),ec.start())):console.log("[schematic] write code error: addr = "+a+", data = "+b)}}}();td4.ctrl=function(){var n,B,s,k,e,g,h,p,w,b,z;function I(c){var d=c.find(".td4-ctrl-clock input[type=button]"),l=c.find(".td4-ctrl-registers span");n=c.find(".td4-ctrl-reset input[type=button]");B=$(d[0]);s=$(d[1]);k=$(d[2]);e=c.find(".td4-ctrl-inp input[type=checkbox]");g=c.find(".td4-ctrl-outp-canvas");h=c.find(".td4-ctrl-show-wires input[type=checkbox]");z=b=w=p=void 0;p=$(l[0]);w=$(l[1]);b=$(l[2]);z=$(l[3])}function x(){td4.shell.isRunning()&&td4.shell.stopClock()}function v(b,c){return function(){var d=
!1;this.value===b&&(d=!0);x();d&&td4.shell.startClock(c)}}function y(b){1===b?s.val("stop"):10===b&&k.val("stop")}function c(){"stop"===s.val()?s.val("1Hz"):"stop"===k.val()&&k.val("10Hz")}function d(b,c){var d=24*(3-b)+10;C.fillStyle=c?"red":"white";C.beginPath();C.arc(d,10,9,0,H);C.fill();C.stroke()}function J(b,c){d(b,c)}function F(b){for(var c=b.toString(2)+String();4>c.length;)c="0"+c;return[c," (",b,")"].join("")}function G(c){var d,e,a;d=td4.shell.getRegisterA();e=td4.shell.getRegisterB();
a=td4.shell.getCarryFlag();D.regA!==d?(p.text(F(d)),p.css("background-color","#ABFEBF"),D.regA=d):p.css("background-color","");D.regB!==e?(b.text(F(e)),b.css("background-color","#ABFEBF"),D.regB=e):b.css("background-color","");D.regPC!==c&&(w.text(F(c)),D.regPC=c);D.regCF!==a?(1===a?z.text("ON"):0===a?z.text("OFF"):z.text("?"),z.css("background-color","#ABFEBF"),D.regCF=a):z.css("background-color","")}var H=2*Math.PI,D={regA:0,regB:0,regPC:0,regCF:0},C;z=b=w=p=h=g=e=k=s=B=n=void 0;return{initModule:function(b){b.html('<div class="td4-ctrl"><fieldset class="td4-ctrl-show-wires"><legend>Show Wires</legend><input type="checkbox" value="clock" checked>Clock&nbsp;&nbsp;</input><input type="checkbox" value="reset" checked>Reset&nbsp;&nbsp;</input><input type="checkbox" value="inp" checked>IN Port&nbsp;&nbsp;</input></fieldset><fieldset class="td4-ctrl-reset"><legend>Reset</legend><input type="button" value="RESET" /></fieldset><fieldset class="td4-ctrl-outp"><legend>OUT PORT</legend><canvas class="td4-ctrl-outp-canvas" width="92" height="20">Canvas not supported</canvas></fieldset><fieldset class="td4-ctrl-inp"><legend>IN PORT</legend><input type="checkbox" value="3" /><input type="checkbox" value="2" /><input type="checkbox" value="1" /><input type="checkbox" value="0" /></fieldset><fieldset class="td4-ctrl-clock"><legend>Clock</legend><input type="button" value="Manual" /><input type="button" value="1Hz" /><input type="button" value="10Hz" /></fieldset><fieldset class="td4-ctrl-registers"><legend>Registers</legend><p>A: <span>0000 (0)</span>&nbsp;&nbsp;PC: <span>0000 (0)</span><br />B: <span>0000 (0)</span>&nbsp;&nbsp;CF: <span>OFF</span></p></fieldset></div>');
I(b);td4.shell.addClockStartedListener({onClockStart:y});td4.shell.addClockStoppedListener({onClockStop:c});td4.shell.addOutpChangeListener({onOutpChange:J});td4.shell.addPcChangeListener({onPcChange:G});n.click(function(){var b;"stop"===s.val()?b=1:"stop"===k.val()&&(b=10);x();td4.shell.reset();td4.shell.reset();1===b?s.click():10===b&&k.click()});s.click(v("1Hz",1));k.click(v("10Hz",10));B.click(function(){x();td4.shell.manualClock()});e.change(function(){td4.shell.setInPort($(this).val(),$(this).is(":checked"))});
h.change(function(){td4.shell.showWire($(this).val(),$(this).is(":checked"))});C=g[0].getContext("2d");C.strokeStyle="black";for(b=0;4>b;b++)d(b,!1)}}}();td4.asm=function(){var n,B,s,k,e,g,h,p,w,b,z;function I(a){var c,d,f;n=a.find(".td4-asm-editor");B=a.find(".td4-asm-console");s=a.find(".td4-asm-code-table-sample");z=b=w=p=h=g=e=k=void 0;k=[];e=[];g=[];h=[];p=[];w=[];d=a.find(".td4-asm-code-row");for(c=0;c<d.length;c++)k[c]=$(d[c]),w[c]=k[c].find("input[type=checkbox]"),f=k[c].find("select"),e[c]=$(f[0]),g[c]=$(f[1]),h[c]=$(f[2]),p[c]=k[c].find(".td4-asm-code-row-bin");a=a.find(".td4-asm-assembler input[type=button]");b=$(a[0]);z=$(a[1])}function x(a,
b){for(var c=a+String();c.length<b;)c="0"+c;return c}function v(a,b){null===a?B.text(b):B.text(["line ",a,": ",b].join(""))}function y(a){return"a"===a.toLowerCase()||"b"===a.toLowerCase()?a.toLowerCase():null}function c(a){var b;if(b=a.match(t))return parseInt(b[1],2);if(b=a.match(W))return parseInt(b[1],16);b=a.match(r);if(!b)return null;a=parseInt(b[1],10);return 16<=a?null:a}function d(a,b,d){var e=c(b);return null===e?(v(d,"invalid immediate value "+b),null):a|e}function J(a,b,c,e){a=a.toLowerCase();
b=b.toLowerCase();if("in"===a)return a=y(b),null===a?(v(c,"'in' op must take a or b argument"),null):"a"===a?32:96;if("out"===a)return"b"===b.toLowerCase()?144:d(176,b,c);if("jnc"===a)return void 0!==e[b]?224|e[b]:d(224,b,c);if("jmp"===a)return void 0!==e[b]?240|e[b]:d(240,b,c);v(c,"invalid op "+a);return null}function F(a,b,c,e){a=a.toLowerCase();b=b.toLowerCase();c=c.toLowerCase();if("add"===a)return a=y(b),null===a?(v(e,"'add' op must take a or b argument"),null):"a"===a?d(0,c,e):d(80,c,e);if("mov"===
a){a=y(b);if(null===a)return v(e,"'in' op must take a or b argument"),null;b=y(c);return"a"===a&&"b"===b?16:"b"===a&&"a"===b?64:"a"===a?d(48,c,e):d(112,c,e)}v(e,"invalid op "+a);return null}function G(a,b,c){if(16<=a.length)return v(c,"over 16 instructions"),!1;a.push(b);return!0}function H(a){var b=[];a=a.split("\n");var c,d,e={},f;for(c=1;c<=a.length;c++)if(d=a[c-1],f=d.match(L),!f)if(f=d.match(M)){if(!G(b,0,c))return null}else if(f=d.match(Q)){d=f[1];if(y(d))return v(c,"label name error. "+d+" is register name"),
null;if(void 0!==e[d])return v(c,"label name conflict error"),null;e[d]=b.length}else if(f=d.match(U)){if(d=J(f[1],f[2],c,e),null===d||!G(b,d,c))return null}else if(f=d.match(V)){if(d=F(f[1],f[2],f[3],c),null===d||!G(b,d,c))return null}else return v(c,"syntax error"),null;return b}function D(){var a,b=[];for(a=0;16>a;a++)b=b.concat(['<div class="td4-asm-code-row">','<input type="checkbox"></input><span>',x(a,2),'</span><select><option value="',a,',add">ADD</option><option value="',a,',mov">MOV</option><option value="',
a,',out">OUT</option><option value="',a,',jmp">JMP</option><option value="',a,',in">IN</option><option value="',a,',jnc">JNC</option></select>',"<select disabled></select><select disabled></select>",'<span class="td4-asm-code-row-bin">0000 0000 (0x00)</span></div>']);K.main_html=K.main_html.replace("{{TD4-ASM-CODE-ROWS}}",b.join(""))}function C(a,b,c){b.text("");if(0===c)b.prop("disabled","disabled");else if(b.prop("disabled",!1),c&1&&b.append($("<option>A</option>").val(a+",a")),c&2&&b.append($("<option>B</option>").val(a+
",b")),c&4)for(c=0;16>c;c++)b.append($("<option></option>").val(a+","+c).text(c))}function q(a,b,c){C(a,g[a],b);C(a,h[a],c)}function E(a,b){A.code[a]=b;var c;c=b&15;c=[x(((b&240)>>4).toString(2),4)," ",x(c.toString(2),4)," (0x",x(b.toString(16).toUpperCase(),2),")"];p[a].text(c.join(""));for(c=0;c<R.length;c++)R[c].onCodeChange(a,b)}function l(a,b){var c,d;if(!(0<=a&&16>a&&0<=b&&256>b))return console.log("[asm] write code error: addr = "+a+", data = "+b),!1;c=b&240;d=b&15;switch(c){case 0:q(a,3,4);
e[a].val(a+",add");g[a].val(a+",a");h[a].val(a+","+d);break;case 16:q(a,3,7);e[a].val(a+",mov");g[a].val(a+",a");h[a].val(a+",b");if(d)return console.log("writeCode error: addr = "+a+", data = "+b),!1;break;case 32:q(a,3,0);e[a].val(a+",in");g[a].val(a+",a");if(d)return console.log("writeCode error: addr = "+a+", data = "+b),!1;break;case 48:q(a,3,7);e[a].val(a+",mov");g[a].val(a+",a");h[a].val(a+","+d);h[a].find('option[value="'+a+',a"]').remove();break;case 64:q(a,3,7);e[a].val(a+",mov");g[a].val(a+
",b");h[a].val(a+",a");if(d)return console.log("writeCode error: addr = "+a+", data = "+b),!1;break;case 80:q(a,3,4);e[a].val(a+",add");g[a].val(a+",b");h[a].val(a+","+d);break;case 96:q(a,3,0);e[a].val(a+",in");g[a].val(a+",b");if(d)return console.log("writeCode error: addr = "+a+", data = "+b),!1;break;case 112:q(a,3,7);e[a].val(a+",mov");g[a].val(a+",b");h[a].val(a+","+d);h[a].find('option[value="'+a+',b"]').remove();break;case 144:q(a,6,0);e[a].val(a+",out");g[a].val(a+",b");if(d)return console.log("writeCode error: addr = "+
a+", data = "+b),!1;break;case 176:q(a,6,0);e[a].val(a+",out");g[a].val(a+","+d);break;case 224:q(a,4,0);e[a].val(a+",jnc");g[a].val(a+","+d);break;case 240:q(a,4,0);e[a].val(a+",jmp");g[a].val(a+","+d);break;default:console.log("onOpcodeChange error: invalid opcode "+c)}E(a,b);return!0}function a(){var a,b;b=$(this).val().split(",");a=parseInt(b[0],10);b=b[1];void 0!==T[b]?(l(a,T[b]),s.val("custom")):console.log("onOpcodeChange error: invalid op "+b)}function m(a){var b,c,d;if(!(0<=a&&16>a))return null;
b=e[a].val().split(",")[1];c=g[a].val().split(",")[1];try{d=h[a].val().split(",")[1]}catch(f){d=null}if("add"===b)return a=parseInt(d,10),"a"===c?0|a:80|a;if("mov"===b){if("a"===c&&"b"===d)return 16;if("b"===c&&"a"===d)return 64;a=parseInt(d,10);return"a"===c?48|a:112|a}return"out"===b?"b"===c?144:176|parseInt(c,10):"jmp"===b?240|parseInt(c,10):"in"===b?"a"===c?32:96:"jnc"===b?224|parseInt(c,10):null}function u(){var a,b;a=$(this).val().split(",");a=parseInt(a[0],10);e[a].val()===a+",mov"&&17===h[a].children("option").length&&
(b=g[a].val().split(",")[1],h[a].find("option:first").remove(),"a"===b?h[a].prepend($("<option>B</option>").val(a+",b")):h[a].prepend($("<option>A</option>").val(a+",a")));b=m(a);null!==b&&E(a,b);s.val("custom")}function f(){var a,b;a=$(this).val().split(",");a=parseInt(a[0],10);b=m(a);null!==b&&E(a,b);s.val("custom")}function N(a){a!==A.currentPc&&(k[A.currentPc].css("background-color",""),k[a].css("background-color","#ABBFFE"),A.currentPc=a,w[a].is(":checked")&&(k[a].css("background-color","#FEABBF"),
td4.shell.stopClock()))}function O(){var a;"string"===typeof K.init_code?(n.text(K.init_code),a=H(K.init_code),A.code=a?a:[]):A.code=K.init_code.slice(0);for(a=0;16>a;a++)a>=A.code.length&&(A.code[a]=0),l(a,A.code[a])}function P(){var a,b,c=[""],d,e;for(a=15;0<=a&&0===A.code[a];a--);if(-1===a)return"";b=a+1;for(a=0;a<b;a++)d=A.code[a]&240,e=A.code[a]&15,0===d?0===e?c.push("nop\n"):(c.push("add a, "),c.push(e),c.push("\n")):16===d?c.push("mov a, b\n"):32===d?c.push("in  a\n"):48===d?(c.push("mov a, "),
c.push(e),c.push("\n")):64===d?c.push("mov b, a\n"):80===d?0===e?c.push("nop\n"):(c.push("add b, "),c.push(e),c.push("\n")):96===d?c.push("in  b\n"):112===d?(c.push("mov b, "),c.push(e),c.push("\n")):144===d?c.push("out b\n"):176===d?(c.push("out "),c.push(e),c.push("\n")):224===d?(c.push("jnc "),c.push(e),c.push("\n")):240===d?(c.push("jmp "),c.push(e),c.push("\n")):console.log("getAssemblerText error: invalid opcode "+d);return c.join("")}var L=/^\s*((;|#|\/\/).*)?$/,M=/^\s*nop\s*((;|#|\/\/).*)?$/i,
Q=/^\s*([\w\d_]+):\s*((;|#|\/\/).*)?$/,U=/^\s*(\w+)\s+([\w\d_]+)\s*((;|#|\/\/).*)?$/,V=/^\s*(\w+)\s+([\w\d_]+)\s*(?:\s|,)\s*([\w\d_]+)\s*((;|#|\/\/).*)?$/,t=/^(?:0b)?((?:0|1){4})$/i,W=/^0x0?([\da-f])$/i,r=/^(1?\d)$/,S=[183,1,225,1,227,182,1,230,1,232,176,180,1,234,184,255],X=[179,182,188,184,184,188,182,179,177,240],T={nop:0,add:0,mov:48,out:176,jmp:240,"in":32,jnc:224},K={main_html:'<div class="td4-asm"><fieldset class="td4-asm-code-table"><legend>Code</legend><div><select class="td4-asm-code-table-sample"><option value="ramen">Ramen Timer</option><option value="knight">Knight2K</option><option value="custom">Custom</option></select></div>{{TD4-ASM-CODE-ROWS}}</fieldset><fieldset class="td4-asm-assembler"><legend>Assembler</legend><div><input type="button" value="Load"></input><input type="button" value="Assemble"></input></div><textarea class="td4-asm-editor" rows="20" cols="40"></textarea><textarea class="td4-asm-console rows="2" cols="40" readonly></textarea></fieldset></div>',
init_code:S},A={code:null,currentPc:0};z=b=w=p=h=g=e=k=s=B=n=void 0;var R=[];return{initModule:function(c){D();c.html(K.main_html);I(c);for(c=0;16>c;c++)e[c].change(a),g[c].change(u),h[c].change(f);k[0].css("background-color","#ABBFFE");td4.shell.addPcChangeListener({onPcChange:N});O();b.click(function(){n.val(P());v(null,"done")});z.click(function(){var a;if(a=H(n.val())){A.code=a;for(a=0;16>a;a++)a>=A.code.length&&(A.code[a]=0),l(a,A.code[a]);v(null,"well done");s.val("custom")}});s.change(function(){var a;
a=$(this).val();if("ramen"===a)a=S;else if("knight"===a)a=X;else return;A.code=a.slice(0);td4.shell.isRunning()&&td4.shell.stopClock();for(a=0;16>a;a++)a>=A.code.length&&(A.code[a]=0),l(a,A.code[a]);td4.shell.reset();td4.shell.reset()})},MAX_PC:16,readCode:function(a){return 0<=a&&16>a?A.code[a]:(console.log("[asm] read code error: addr = "+a),0)},wirteCode:l,assemble:H,addCodeChangeListener:function(a){R.push(a)}}}();
